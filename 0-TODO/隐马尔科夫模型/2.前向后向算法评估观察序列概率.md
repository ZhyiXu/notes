# 前向后向算法评估观察序列概率

文章地址: https://www.cnblogs.com/pinard/p/6955871.html

　在[隐马尔科夫模型HMM（一）HMM模型](http://www.cnblogs.com/pinard/p/6945257.html)中，我们讲到了HMM模型的基础知识和HMM的三个基本问题，本篇我们就关注于HMM第一个基本问题的解决方法，即已知模型和观测序列，求观测序列出现的概率。

# 1. 回顾HMM问题一：求观测序列的概率

　　　　首先我们回顾下HMM模型的问题一。这个问题是这样的。我们已知HMM模型的参数λ=(A,B,Π)λ=(A,B,Π)。其中AA是隐藏状态转移概率的矩阵，BB是观测状态生成概率的矩阵， ΠΠ是隐藏状态的初始概率分布。同时我们也已经得到了观测序列O={o1,o2,...oT}O={o1,o2,...oT},现在我们要求观测序列OO在模型λλ下出现的条件概率P(O|λ)P(O|λ)。

　　　　乍一看，这个问题很简单。因为我们知道所有的隐藏状态之间的转移概率和所有从隐藏状态到观测状态生成概率，那么我们是可以暴力求解的。

　　　　我们可以列举出所有可能出现的长度为TT的隐藏序列I={i1,i2,...,iT}I={i1,i2,...,iT},分布求出这些隐藏序列与观测序列O={o1,o2,...oT}O={o1,o2,...oT}的联合概率分布P(O,I|λ)P(O,I|λ)，这样我们就可以很容易的求出边缘分布P(O|λ)P(O|λ)了。

　　　　具体暴力求解的方法是这样的：首先，任意一个隐藏序列I={i1,i2,...,iT}I={i1,i2,...,iT}出现的概率是：P(I|λ)=πi1ai1i2ai2i3...aiT−1iTP(I|λ)=πi1ai1i2ai2i3...aiT−1iT

　　　　对于固定的状态序列I={i1,i2,...,iT}I={i1,i2,...,iT}，我们要求的观察序列O={o1,o2,...oT}O={o1,o2,...oT}出现的概率是：P(O|I,λ)=bi1(o1)bi2(o2)...biT(oT)P(O|I,λ)=bi1(o1)bi2(o2)...biT(oT)

　　　　则OO和II联合出现的概率是：P(O,I|λ)=P(I|λ)P(O|I,λ)=πi1bi1(o1)ai1i2bi2(o2)...aiT−1iTbiT(oT)P(O,I|λ)=P(I|λ)P(O|I,λ)=πi1bi1(o1)ai1i2bi2(o2)...aiT−1iTbiT(oT)

　　　　然后求边缘概率分布，即可得到观测序列OO在模型λλ下出现的条件概率P(O|λ)P(O|λ)：P(O|λ)=∑IP(O,I|λ)=∑i1,i2,...iTπi1bi1(o1)ai1i2bi2(o2)...aiT−1iTbiT(oT)P(O|λ)=∑IP(O,I|λ)=∑i1,i2,...iTπi1bi1(o1)ai1i2bi2(o2)...aiT−1iTbiT(oT)

　　　　虽然上述方法有效，但是如果我们的隐藏状态数NN非常多的那就麻烦了，此时我们预测状态有NTNT种组合，算法的时间复杂度是O(TNT)O(TNT)阶的。因此对于一些隐藏状态数极少的模型，我们可以用暴力求解法来得到观测序列出现的概率，但是如果隐藏状态多，则上述算法太耗时，我们需要寻找其他简洁的算法。

　　　　前向后向算法就是来帮助我们在较低的时间复杂度情况下求解这个问题的。

# 2. 用前向算法求HMM观测序列的概率

　　　　前向后向算法是前向算法和后向算法的统称，这两个算法都可以用来求HMM观测序列的概率。我们先来看看前向算法是如何求解这个问题的。

　　　　前向算法本质上属于动态规划的算法，也就是我们要通过找到局部状态递推的公式，这样一步步的从子问题的最优解拓展到整个问题的最优解。

　　　　在前向算法中，通过定义“前向概率”来定义动态规划的这个局部状态。什么是前向概率呢, 其实定义很简单：定义时刻tt时隐藏状态为qiqi, 观测状态的序列为o1,o2,...oto1,o2,...ot的概率为前向概率。记为：αt(i)=P(o1,o2,...ot,it=qi|λ)αt(i)=P(o1,o2,...ot,it=qi|λ)

　　　　既然是动态规划，我们就要递推了，现在我们假设我们已经找到了在时刻tt时各个隐藏状态的前向概率，现在我们需要递推出时刻t+1t+1时各个隐藏状态的前向概率。

　　　　从下图可以看出，我们可以基于时刻tt时各个隐藏状态的前向概率，再乘以对应的状态转移概率，即αt(j)ajiαt(j)aji就是在时刻tt观测到o1,o2,...oto1,o2,...ot，并且时刻tt隐藏状态qjqj, 时刻t+1t+1隐藏状态qiqi的概率。如果将想下面所有的线对应的概率求和，即N∑j=1αt(j)aji∑j=1Nαt(j)aji就是在时刻tt观测到o1,o2,...oto1,o2,...ot，并且时刻t+1t+1隐藏状态qiqi的概率。继续一步，由于观测状态ot+1ot+1只依赖于t+1t+1时刻隐藏状态qiqi, 这样[N∑j=1αt(j)aji]bi(ot+1)[∑j=1Nαt(j)aji]bi(ot+1)就是在在时刻t+1t+1观测到o1,o2,...ot，ot+1o1,o2,...ot，ot+1，并且时刻t+1t+1隐藏状态qiqi的概率。而这个概率，恰恰就是时刻t+1t+1对应的隐藏状态ii的前向概率，这样我们得到了前向概率的递推关系式如下：αt+1(i)=[N∑j=1αt(j)aji]bi(ot+1)αt+1(i)=[∑j=1Nαt(j)aji]bi(ot+1)

![img](https://images2015.cnblogs.com/blog/1042406/201706/1042406-20170607140245012-63214356.png)

　　　　我们的动态规划从时刻1开始，到时刻TT结束，由于αT(i)αT(i)表示在时刻TT观测序列为o1,o2,...oTo1,o2,...oT，并且时刻TT隐藏状态qiqi的概率，我们只要将所有隐藏状态对应的概率相加，即N∑i=1αT(i)∑i=1NαT(i)就得到了在时刻TT观测序列为o1,o2,...oTo1,o2,...oT的概率。

　　　　下面总结下前向算法。

　　　　输入：HMM模型λ=(A,B,Π)λ=(A,B,Π)，观测序列O=(o1,o2,...oT)O=(o1,o2,...oT)

　　　　输出：观测序列概率P(O|λ)P(O|λ)

　　　　1) 计算时刻1的各个隐藏状态前向概率：α1(i)=πibi(o1),i=1,2,...Nα1(i)=πibi(o1),i=1,2,...N

　　　　2) 递推时刻2,3,...T2,3,...T时刻的前向概率：αt+1(i)=[N∑j=1αt(j)aji]bi(ot+1),i=1,2,...Nαt+1(i)=[∑j=1Nαt(j)aji]bi(ot+1),i=1,2,...N

　　　　3) 计算最终结果：P(O|λ)=N∑i=1αT(i)P(O|λ)=∑i=1NαT(i)

　　　　从递推公式可以看出，我们的算法时间复杂度是O(TN2)O(TN2)，比暴力解法的时间复杂度O(TNT)O(TNT)少了几个数量级。

# 3. HMM前向算法求解实例

　　　　这里我们用[隐马尔科夫模型HMM（一）HMM模型](http://www.cnblogs.com/pinard/p/6945257.html)中盒子与球的例子来显示前向概率的计算。

　　　　我们的观察集合是:V={红，白}，M=2V={红，白}，M=2

　　　　我们的状态集合是：Q={盒子1，盒子2，盒子3}，N=3Q={盒子1，盒子2，盒子3}，N=3

　　　　而观察序列和状态序列的长度为3.

　　　　初始状态分布为：Π=(0.2,0.4,0.4)TΠ=(0.2,0.4,0.4)T

　　　　状态转移概率分布矩阵为：

A=⎛⎜⎝0.50.20.30.30.50.20.20.30.5⎞⎟⎠A=(0.50.20.30.30.50.20.20.30.5)

 　　　　观测状态概率矩阵为：

B=⎛⎜⎝0.50.50.40.60.70.3⎞⎟⎠B=(0.50.50.40.60.70.3)

　　　　球的颜色的观测序列:O={红，白，红}O={红，白，红}

　　　　按照我们上一节的前向算法。首先计算时刻1三个状态的前向概率：

　　　　时刻1是红色球，隐藏状态是盒子1的概率为：α1(1)=π1b1(o1)=0.2×0.5=0.1α1(1)=π1b1(o1)=0.2×0.5=0.1

　　　　隐藏状态是盒子2的概率为：α1(2)=π2b2(o1)=0.4×0.4=0.16α1(2)=π2b2(o1)=0.4×0.4=0.16

　　　　隐藏状态是盒子3的概率为：α1(3)=π3b3(o1)=0.4×0.7=0.28α1(3)=π3b3(o1)=0.4×0.7=0.28

　　　　现在我们可以开始递推了，首先递推时刻2三个状态的前向概率：

　　　　时刻2是白色球，隐藏状态是盒子1的概率为：α2(1)=[3∑i=1α1(i)ai1]b1(o2)=[0.1∗0.5+0.16∗0.3+0.28∗0.2]×0.5=0.077α2(1)=[∑i=13α1(i)ai1]b1(o2)=[0.1∗0.5+0.16∗0.3+0.28∗0.2]×0.5=0.077

　　　　隐藏状态是盒子2的概率为：α2(2)=[3∑i=1α1(i)ai2]b2(o2)=[0.1∗0.2+0.16∗0.5+0.28∗0.3]×0.6=0.1104α2(2)=[∑i=13α1(i)ai2]b2(o2)=[0.1∗0.2+0.16∗0.5+0.28∗0.3]×0.6=0.1104

　　　　隐藏状态是盒子3的概率为：α2(3)=[3∑i=1α1(i)ai3]b3(o2)=[0.1∗0.3+0.16∗0.2+0.28∗0.5]×0.3=0.0606α2(3)=[∑i=13α1(i)ai3]b3(o2)=[0.1∗0.3+0.16∗0.2+0.28∗0.5]×0.3=0.0606

　　　　继续递推，现在我们递推时刻3三个状态的前向概率：

　　　　时刻3是红色球，隐藏状态是盒子1的概率为：α3(1)=[3∑i=1α2(i)ai1]b1(o3)=[0.077∗0.5+0.1104∗0.3+0.0606∗0.2]×0.5=0.04187α3(1)=[∑i=13α2(i)ai1]b1(o3)=[0.077∗0.5+0.1104∗0.3+0.0606∗0.2]×0.5=0.04187

　　　　隐藏状态是盒子2的概率为：α3(2)=[3∑i=1α2(i)ai2]b2(o3)=[0.077∗0.2+0.1104∗0.5+0.0606∗0.3]×0.4=0.03551α3(2)=[∑i=13α2(i)ai2]b2(o3)=[0.077∗0.2+0.1104∗0.5+0.0606∗0.3]×0.4=0.03551

　　　　隐藏状态是盒子3的概率为：α3(3)=[3∑i=1α2(i)ai3]b3(o3)=[0.077∗0.3+0.1104∗0.2+0.0606∗0.5]×0.7=0.05284α3(3)=[∑i=13α2(i)ai3]b3(o3)=[0.077∗0.3+0.1104∗0.2+0.0606∗0.5]×0.7=0.05284

　　　　最终我们求出观测序列:O={红，白，红}O={红，白，红}的概率为：P(O|λ)=3∑i=1α3(i)=0.13022P(O|λ)=∑i=13α3(i)=0.13022

# 4. 用后向算法求HMM观测序列的概率

　　　　熟悉了用前向算法求HMM观测序列的概率，现在我们再来看看怎么用后向算法求HMM观测序列的概率。

　　　　后向算法和前向算法非常类似，都是用的动态规划，唯一的区别是选择的局部状态不同，后向算法用的是“后向概率”，那么后向概率是如何定义的呢？

　　　　定义时刻tt时隐藏状态为qiqi, 从时刻t+1t+1到最后时刻TT的观测状态的序列为ot+1,ot+2,...oTot+1,ot+2,...oT的概率为后向概率。记为：βt(i)=P(ot+1,ot+2,...oT|it=qi,λ)βt(i)=P(ot+1,ot+2,...oT|it=qi,λ)

　　　　后向概率的动态规划递推公式和前向概率是相反的。现在我们假设我们已经找到了在时刻t+1t+1时各个隐藏状态的后向概率βt+1(j)βt+1(j)，现在我们需要递推出时刻tt时各个隐藏状态的后向概率。如下图，我们可以计算出观测状态的序列为ot+2,ot+3,...oTot+2,ot+3,...oT， tt时隐藏状态为qiqi, 时刻t+1t+1隐藏状态为qjqj的概率为aijβt+1(j)aijβt+1(j), 接着可以得到观测状态的序列为ot+1,ot+2,...oTot+1,ot+2,...oT， tt时隐藏状态为qiqi, 时刻t+1t+1隐藏状态为qjqj的概率为aijbj(ot+1)βt+1(j)aijbj(ot+1)βt+1(j), 则把下面所有线对应的概率加起来，我们可以得到观测状态的序列为ot+1,ot+2,...oTot+1,ot+2,...oT， tt时隐藏状态为qiqi的概率为N∑j=1aijbj(ot+1)βt+1(j)∑j=1Naijbj(ot+1)βt+1(j)，这个概率即为时刻tt的后向概率。

![img](https://images2015.cnblogs.com/blog/1042406/201706/1042406-20170607172032606-996787196.png)

　　　　这样我们得到了后向概率的递推关系式如下：βt(i)=N∑j=1aijbj(ot+1)βt+1(j)βt(i)=∑j=1Naijbj(ot+1)βt+1(j)

　　　　现在我们总结下后向算法的流程,注意下和前向算法的相同点和不同点：

　　　　输入：HMM模型λ=(A,B,Π)λ=(A,B,Π)，观测序列O=(o1,o2,...oT)O=(o1,o2,...oT)

　　　　输出：观测序列概率P(O|λ)P(O|λ)

　　　　1) 初始化时刻TT的各个隐藏状态后向概率：βT(i)=1,i=1,2,...NβT(i)=1,i=1,2,...N

　　　　2) 递推时刻T−1,T−2,...1T−1,T−2,...1时刻的后向概率：βt(i)=N∑j=1aijbj(ot+1)βt+1(j),i=1,2,...Nβt(i)=∑j=1Naijbj(ot+1)βt+1(j),i=1,2,...N

　　　　3) 计算最终结果：P(O|λ)=N∑i=1πibi(o1)β1(i)P(O|λ)=∑i=1Nπibi(o1)β1(i)

　　　　此时我们的算法时间复杂度仍然是O(TN2)O(TN2)。

# 5. HMM常用概率的计算

　　　　利用前向概率和后向概率，我们可以计算出HMM中单个状态和两个状态的概率公式。

　　　　1）给定模型λλ和观测序列OO,在时刻tt处于状态qiqi的概率记为:γt(i)=P(it=qi|O,λ)=P(it=qi,O|λ)P(O|λ)γt(i)=P(it=qi|O,λ)=P(it=qi,O|λ)P(O|λ)

　　　　利用前向概率和后向概率的定义可知：P(it=qi,O|λ)=αt(i)βt(i)P(it=qi,O|λ)=αt(i)βt(i)

　　　　于是我们得到：γt(i)=αt(i)βt(i)N∑j=1αt(j)βt(j)γt(i)=αt(i)βt(i)∑j=1Nαt(j)βt(j)

　　　　2）给定模型λλ和观测序列OO,在时刻tt处于状态qiqi，且时刻t+1t+1处于状态qjqj的概率记为:ξt(i,j)=P(it=qi,it+1=qj|O,λ)=P(it=qi,it+1=qj,O|λ)P(O|λ)ξt(i,j)=P(it=qi,it+1=qj|O,λ)=P(it=qi,it+1=qj,O|λ)P(O|λ)

　　　　而P(it=qi,it+1=qj,O|λ)P(it=qi,it+1=qj,O|λ)可以由前向后向概率来表示为:P(it=qi,it+1=qj,O|λ)=αt(i)aijbj(ot+1)βt+1(j)P(it=qi,it+1=qj,O|λ)=αt(i)aijbj(ot+1)βt+1(j)

　　　　从而最终我们得到ξt(i,j)ξt(i,j)的表达式如下：ξt(i,j)=αt(i)aijbj(ot+1)βt+1(j)N∑r=1N∑s=1αt(r)arsbs(ot+1)βt+1(s)ξt(i,j)=αt(i)aijbj(ot+1)βt+1(j)∑r=1N∑s=1Nαt(r)arsbs(ot+1)βt+1(s)

 　　　　3) 将γt(i)γt(i)和ξt(i,j)ξt(i,j)在各个时刻tt求和，可以得到：

　　　　在观测序列OO下状态ii出现的期望值T∑t=1γt(i)∑t=1Tγt(i)

　　　　在观测序列OO下由状态ii转移的期望值T−1∑t=1γt(i)∑t=1T−1γt(i)

　　　　在观测序列OO下由状态ii转移到状态jj的期望值T−1∑t=1ξt(i,j)∑t=1T−1ξt(i,j)

　　　　上面这些常用的概率值在求解HMM问题二，即求解HMM模型参数的时候需要用到。我们在这个系列的第三篇来讨论求解HMM参数的问题和解法。