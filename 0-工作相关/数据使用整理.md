

### 1.商品维表

#### 直播上架商品维表（包含闪电购商品）

```sql
select *
from ks_plateco.dw_dim_ad_merchant_live_shelf_item_df
where live_id = '7033493250' and p_date = '20200914'
--DDL
CREATE TABLE IF NOT EXISTS ks_plateco.dw_dim_ad_merchant_live_shelf_item_df (
  `live_id` bigint COMMENT '来源ID',
  `seller_id` bigint COMMENT '商家id',
  `item_id` bigint COMMENT '商品id',
  `start_time` bigint COMMENT '商品上架时间',
  `end_time` bigint COMMENT '商品下架时间',
  `logno` bigint COMMENT '上架商品顺序'
) COMMENT '直播上架商品维表' PARTITIONED BY (`p_date` string)
```

#### 闪电购商品登记表

```sql
select *
from ks_db_origin.ad_merchant_sandeago_info_dt_snapshot 
where live_id ='7033493250' and dt = '2020-09-14'
----DDL
CREATE TABLE IF NOT EXISTS ks_db_origin.ad_merchant_sandeago_info_dt_snapshot (
  `__binlog_timestamp` bigint COMMENT 'binlog时间戳',
  `__binlog_type` string COMMENT 'binlog类型',
  `image_id` bigint COMMENT '图片id',
  `shelf_item_id` bigint COMMENT '商品id',
  `user_id` bigint COMMENT '卖家快手id',
  `live_id` bigint COMMENT '直播id',
  `item_cdn_img_url` string COMMENT '商品cdn图片地址',
  `initial_stock` bigint COMMENT '商品总库存',
  `initial_price` bigint COMMENT '价格，单位分',
  `purchase_limit` bigint COMMENT '限购数量',
  `sell_status` int COMMENT '售卖状态 0 未知 1待售 2售卖中 3 关闭',
  `create_time` bigint COMMENT '创建时间',
  `update_time` bigint COMMENT '修改时间'
) COMMENT '闪电购添加商品记录表' PARTITIONED BY (`dt` string COMMENT 'yyyy-MM-dd')
```

#### 电商货架商品维表，包含商品类目

```sql
ks_plateco_core.dim_item_shelf_info_df --全量表，增量更新
字段链接：
https://meta.corp.kuaishou.com/v2/#/assets/detail?category=HIVE&urn=ks%3Ahive%2Ftable%3Aks_plateco_core%2Fdim_item_shelf_info_df&caseId=1005&tab=%E6%A1%88%E4%BE%8B%E5%88%86%E4%BA%AB&action=gotoCaseDetail
有案例分享，所有商品
--与直播idjoin

```



### 2.直播间表

#### 直播间粒度表--下线中

```sql
ks_dws.party_allprod_live_active_di 
select * from ks_dws.party_allprod_live_active_di 
where p_date ='20200318' and live_stream_id = '6106826919'
```

#### 活跃直播间粒度表

```sql
ksapp.ads_ks_live_aggr_1d
```

#### 直播评论事实表

```sql
kscdm.dwd_ks_csm_cmt_live_hi
--不包含语音评论内容，但先该评论时长
```

#### 直播间购物车表 -- 下线中

```sql
ks_plateco_core.fact_live_item_operation_hi
select live_id,size(items_id) as item_num
from ks_plateco_core.fact_live_item_operation_hi
where p_date ='20200318' and live_id = '6106826919'
--DDL
CREATE TABLE IF NOT EXISTS ks_plateco_core.fact_live_item_operation_hi (
  `live_id` bigint COMMENT '直播id',
  `user_id` bigint COMMENT '用户id',
  `items_id` array < bigint > COMMENT '直播当前展示的商品id列表',
  `operation_type` bigint COMMENT '操作类型, 1新增 2修改',
  `new_items_id` array < bigint > COMMENT '操作的商品id',
  `opreation_time` bigint COMMENT '操作时间'
) COMMENT '电商直播上架明细' PARTITIONED BY (
  `p_date` string COMMENT '日期分区，格式为yyyyMMdd，eg:20200101',
  `p_hour` string COMMENT '小时分区，格式为HH，eg:08'
)
```

#### 直播间商品上下车表

```sql
ks_plateco_core.fact_content_live_item_all_operation_di
select live_id,count(distinct item_id) as item_num,count(*) as op_cnt
from ks_plateco_core.fact_content_live_item_all_operation_di
where p_date >= '20210228' and live_id = '7745933245'
group by live_id
--DDL
CREATE TABLE IF NOT EXISTS ks_plateco_core.fact_content_live_item_all_operation_di (
  `live_id` bigint COMMENT '直播ID ',
  `author_id` bigint COMMENT '主播ID ',
  `item_id` bigint COMMENT '商品id ',
  `start_time` bigint COMMENT '商品上车时间，单位：ms',
  `start_date` string COMMENT '商品上车时间，格式:2021-01-01 12:01:01:01 ',
  `end_time` bigint COMMENT '商品下车时间戳，单位：ms',
  `end_date` string COMMENT '商品下车时间，格式:2021-01-01 12:01:01:01',
  `item_logno` bigint COMMENT '整体商品上车顺序，代表在本直播上车商品中，本商品第几个上车',
  `curr_item_logno` bigint COMMENT '(预留字段，暂不可用)，本商品上车顺序，代表本商品在直播中第几次上车'
) COMMENT '注意！！因从业务数据很难加工出真实的上下车时间，暂时按照一定逻辑加工出上下车时间（无法非常准确）。闪电购商品开始等于结束时间直播间商品上下车表（包含普通及闪电购商品）' PARTITIONED BY (
  `p_date` string COMMENT '日期,yyyyMMdd eg:20200101'
)
```

### 3.风控

#### 电商风控处罚表

```sql
ks_plateco.dw_fact_ad_merchant_admin_punish_score_action_df
--https://meta.corp.kuaishou.com/v2/#/assets/detail?category=HIVE&urn=ks%3Ahive%2Ftable%3Aks_plateco%2Fdw_fact_ad_merchant_admin_punish_score_action_df
SELECT *
FROM ks_plateco.dw_fact_ad_merchant_admin_punish_score_action_df
WHERE p_date >= '20201001' and punish_level_three_rule_name = '4.13不当使用购物车功能' and punish_live_ids ='7615514982'
--处罚时间与直播实际发生时间未必相等，分区与直播时间无关，分区与处罚时间无关
```

### 4. 建表

ks_rc_eb_dev 或者ks_rc_eb库

```sql
CREATE TABLE IF NOT EXISTS ks_rc_eb.merchant_cheat_order_full_inner
(
  order_id bigint COMMENT '订单id',
  order_date STRING COMMENT '订单日期',
  order_buyer_id bigint COMMENT '买家id',
  order_seller_id bigint COMMENT '卖家id',
  reason STRING COMMENT '一级策略名称',
  sub_reason STRING COMMENT '二级策略名称',
  insert_date STRING COMMENT '策略识别时间'
) COMMENT "刷单结果表-内部使用" partitioned by (p_date STRING COMMENT '日期') stored AS parquet;
SET hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;
SET mapred.max.split.size=256000000;
SET mapreduce.input.fileinputformat.split.maxsize=32000000;
SET hive.exec.reducers.bytes.per.reducer=128000000;
SET hive.specify.execution.engine.enforce.name=spark;
```

